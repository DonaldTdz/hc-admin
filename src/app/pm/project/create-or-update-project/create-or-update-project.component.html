<page-header *ngIf="!id" title="{{title}}">
</page-header>
<nz-card [nzBordered]="false">
  <form nz-form [formGroup]="projectForm" #validateForm="ngForm" class="ant-advanced-search-form" (ngSubmit)="save()"
    *ngIf="project">
    <div nz-row [nzGutter]="24">
      <nz-card [nzBordered]="false" nzTitle="项目编号：{{project.projectCode}}" [nzExtra]="extraTemplate">
        <nz-steps [nzCurrent]="projectStatus.indexOf(project.statusName)" nzProgressDot>
          <nz-step *ngFor="let text of projectStatus" [nzTitle]="text">
          </nz-step>
        </nz-steps>
        <ng-template #extraTemplate>
          <button nz-button type="button" *ngIf="project.status==1 && id" (click)="losing()">丢单</button>
          <button nz-button type="button" [nzType]="'primary'" *ngIf="project.status==1 && id"
            (click)="submit()">提交</button>
          <button nz-button [nzType]="'primary'" type="submit" *ngIf="project.status==1"
            [disabled]="!validateForm.valid||saving">保存</button>
        </ng-template>
      </nz-card>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" class="labelPadding" nzRequired [nzXs]="24">项目编号</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <input nz-input formControlName="projectCode" disabled="true" placeholder="请输入联系人"
              [(ngModel)]="project.projectCode" />
            <nz-form-explain *ngIf="(projectForm.get('projectCode')?.dirty && projectForm.get('projectCode')?.errors)
              ">项目编号不能超过50个字符
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" class="labelPadding" nzRequired [nzXs]="24">项目名称</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <input nz-input formControlName="name" placeholder="请输入项目名称" [(ngModel)]="project.name" />
            <nz-form-explain *ngIf="(projectForm.get('name')?.dirty && projectForm.get('name')?.errors)
              ">项目名称不能为空且不能超过100个字符
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" class="labelPadding" [nzXs]="24">项目分类</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-select [nzPlaceHolder]="'请选择项目分类'" formControlName="type" [(ngModel)]="project.type"
              [nzShowSearch]="true" style="width:100%;">
              <nz-option *ngFor="let i of typeList" [nzLabel]="i.text" [nzValue]="i.value">
              </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" class="labelPadding" [nzXs]="24">所属客户</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-select [nzPlaceHolder]="'请选择所属客户'" formControlName="customerId" [(ngModel)]="project.customerId"
              [nzShowSearch]="true" style="width:100%;">
              <nz-option *ngFor="let i of customerList" [nzLabel]="i.text" [nzValue]="+i.value">
              </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" nzRequired="true" class="labelPadding" [nzXs]="24">负责人</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-select [nzPlaceHolder]="'请选择负责人'" formControlName="employeeId" [(ngModel)]="project.employeeId"
              [nzShowSearch]="true" style="width:100%;">
              <nz-option *ngFor="let i of employeeList" [nzLabel]="i.text" [nzValue]="i.value">
              </nz-option>
            </nz-select>
            <nz-form-explain *ngIf="(projectForm.get('year')?.dirty && projectForm.get('year')?.errors)
              ">负责人不能为空
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" class="labelPadding" nzRequired [nzXs]="24">所属年</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <input nz-input formControlName="year" placeholder="请输入所属年" [(ngModel)]="project.year" />
            <nz-form-explain *ngIf="(projectForm.get('year')?.dirty && projectForm.get('year')?.errors)
              ">所属年不能为空
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" class="labelPadding" [nzXs]="24">开始日期</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-date-picker [nzStyle]='{width:"100%"}' placeholder="请选择开始日期" formControlName="startDate"
              [(ngModel)]="project.startDate"></nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" class="labelPadding" [nzXs]="24">结束日期</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-date-picker [nzStyle]='{width:"100%"}' placeholder="请选择开始日期" [nzFormat]="yyyy" formControlName="endDate"
              [(ngModel)]="project.endDate">
            </nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" class="labelPadding" [nzXs]="24">预算金额(元)</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-input-number formControlName="budget" [nzPrecision]='2' style="width:100%" placeholder="请输入预算金额"
              [(ngModel)]="project.budget">
            </nz-input-number>
            <nz-form-explain *ngIf="(projectForm.get('budget')?.dirty && projectForm.get('budget')?.errors)
                  ">预算金额不能超过18位
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label nz-col class="labelPadding" [nzSm]="8" nzRequired [nzXs]="24">项目模式
          </nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-select formControlName="mode" [nzPlaceHolder]="'请选择项目模式'" [(ngModel)]="project.mode"
              [nzShowSearch]="true" style="width:100%;">
              <nz-option *ngFor="let i of projectMode" [nzLabel]="i.text" [nzValue]="i.value">
              </nz-option>
            </nz-select>
            <nz-form-explain *ngIf="(projectForm.get('mode')?.dirty && projectForm.get('mode')?.errors)
        ">项目模式不能为空
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8" *ngIf="project.mode=='2'">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" class="labelPadding" [nzXs]="24">收益比例</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-input-number formControlName="profitRatio" style="width:90%" placeholder="请输入收益比例"
              [(ngModel)]="project.profitRatio">
            </nz-input-number>%
            <nz-form-explain *ngIf="(projectForm.get('profitRatio')?.dirty && projectForm.get('profitRatio')?.errors)
          ">收益比例不能超过18位
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8" *ngIf="project.mode=='3'">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" class="labelPadding" [nzXs]="24">过单费用(元)</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-input-number formControlName="billCost" style="width:100%" placeholder="请输入过单费用"
              [(ngModel)]="project.billCost">
            </nz-input-number>
            <nz-form-explain *ngIf="(projectForm.get('billCost')?.dirty && projectForm.get('billCost')?.errors)
              ">过单费用不能超过18位
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label nz-col [nzSm]="8" class="labelPadding" [nzXs]="24">项目描述</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <textarea nz-input rows="2" formControlName="desc" placeholder="请输入项目描述"
              [(ngModel)]="project.desc"></textarea>
            <nz-form-explain *ngIf="(projectForm.get('desc')?.dirty && projectForm.get('desc')?.errors)
              ">备注不能超过250个字符
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <nz-card [nzBordered]="true" nzTitle="项目明细" class="mb-lg" [nzExtra]="project.status!=6?detailTemplate:''">
      <!-- <form nz-form [nzLayout]="'inline'" class="search__form">
        <div nz-row [nzGutter]="{ xs: 8, sm: 8, md: 8, lg: 24, xl: 48, xxl: 48 }">
          <div nz-col [nzSpan]="24" style="text-align: right" *ngIf="project.status!=0">
            <button nz-button (click)="createProjectDetail()" nzType="primary">
              <i class="anticon anticon-plus"></i>
              <span>新建</span>
            </button>
          </div>
        </div>
      </form> -->
      <ng-template #detailTemplate>
        <button nz-button type="button" (click)="createProjectDetail()" nzType="primary">
          <i class="anticon anticon-plus"></i>
          <span>新建</span>
        </button>
      </ng-template>
      <nz-table #nzprojectDetailTable [nzData]="projectDetails" [nzFrontPagination]="false" [nzLoading]="loading"
        [nzShowPagination]="false">
        <thead nz-thead>
          <tr>
            <th nz-th>
              <span>商品/服务名称</span>
            </th>
            <th nz-th>
              <span>明细分类</span>
            </th>
            <th nz-th>
              <span>规格型号</span>
            </th>
            <th nz-th>
              <span>单位</span>
            </th>
            <th nz-th style="text-align: right">
              <span>数量</span>
            </th>
            <th style="text-align: right">
              <span>销售单价(元)</span>
            </th>
            <th style="text-align: right">
              <span>总金额(元)</span>
            </th>
            <th style="text-align: center" *ngIf="project.status!=6">
              <span>操作</span>
            </th>
          </tr>
        </thead>
        <tbody nz-tbody>
          <tr nz-tbody-tr *ngFor="let item of nzprojectDetailTable.data; let i = index">
            <td nz-td>{{item.name}}</td>
            <td nz-td>{{item.type}}</td>
            <td nz-td>{{item.specification}}</td>
            <td nz-td>{{item.unit}}</td>
            <td nz-td style="text-align: right">{{item.num}} </td>
            <td nz-td style="text-align: right">{{item.price}} </td>
            <td nz-td style="text-align: right">{{item.totalSum}} </td>
            <td nz-td style="text-align: center" *ngIf="project.status!=6">
              <a (click)="editProjectDetail(item,i)" *ngIf="item.name!='合计'">编辑</a>
              <span nz-table-divider></span>
              <nz-divider nzType="vertical" *ngIf="item.name!='合计'"></nz-divider>
              <a style="color:#ff4d4f;" *ngIf="item.name!='合计'" (click)="delete(item,i)">删除</a>
              <span nz-table-divider></span>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </nz-card>
    <div class="modal-footer">
      <button nz-button type="button" [disabled]="saving" (click)="goBack()">
        返回
      </button>
    </div>
  </form>
</nz-card>
