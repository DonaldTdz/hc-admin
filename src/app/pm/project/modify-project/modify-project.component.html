<page-header title="{{title}}">
</page-header>
<nz-card [nzBordered]="false">
  <form nz-form [formGroup]="form" #validateForm="ngForm" class="ant-advanced-search-form" (ngSubmit)="save()"
    *ngIf="project">
    <div nz-row [nzGutter]="24">
      <nz-steps [nzCurrent]="projectStatus.indexOf(project.statusName)" nzProgressDot>
        <nz-step *ngFor="let text of projectStatus" [nzTitle]="text" (click)="step($event)">
        </nz-step>
      </nz-steps>
      <page-header title="项目编号：{{project.projectCode}}" [action]="extraTemplate">
        <ng-template #extraTemplate>
          <button nz-button type="button" class="button-gray" *ngIf="project.status==2" (click)="submit()">丢单</button>
          <button nz-button [nzType]="'primary'" type="submit" [disabled]="!validateForm.valid||saving">保存</button>
          <button nz-button type="button" class="button-green" *ngIf="project.status==1" (click)="submit()">去立项</button>
          <button nz-button type="button" class="button-green" *ngIf="project.status==2"
            (click)="submit()">完成立项</button>
        </ng-template>
      </page-header>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="8" *ngIf="project.status=='1'">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">项目名称</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <input nz-input formControlName="name" *ngIf="project.status==1" placeholder="请输入项目名称"
              [(ngModel)]="project.name" />
            <input nz-input formControlName="name" *ngIf="project.status!=1" readonly placeholder="请输入项目名称"
              [(ngModel)]="project.name" />
            <nz-form-explain *ngIf="(form.get('name')?.dirty && form.get('name')?.errors)
              ">项目名称不能为空且不能超过100个字符
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">项目类型</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-select [nzPlaceHolder]="'请选择项目类型'" [nzDisabled]="project.id?true:false" formControlName="type"
              [(ngModel)]="project.type" [nzShowSearch]="true" (ngModelChange)="!project.id?generateProjectCode():''"
              style="width:100%;">
              <nz-option *ngFor="let i of typeList" [nzLabel]="i.text" [nzValue]="i.value">
              </nz-option>
            </nz-select>
            <nz-form-explain *ngIf="(form.get('type')?.dirty && form.get('type')?.errors)
            ">项目类型不能为空
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label class="labelPadding" [nzSm]="7" nzRequired [nzXs]="24">项目模式
          </nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-select formControlName="mode" [nzDisabled]="project.status>1?true:false" [nzPlaceHolder]="'请选择项目模式'"
              [(ngModel)]="project.mode" [nzShowSearch]="true" style="width:100%;">
              <nz-option *ngFor="let i of projectMode" [nzLabel]="i.text" [nzValue]="i.value">
              </nz-option>
            </nz-select>
            <nz-form-explain *ngIf="(form.get('mode')?.dirty && form.get('mode')?.errors)
          ">项目模式不能为空
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" nzRequired="true" class="labelPadding" [nzXs]="24">项目销售</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-select [nzPlaceHolder]="'请选择项目销售'" [nzDisabled]="project.status>1?true:false"
              formControlName="projectSalesId" [(ngModel)]="project.projectSalesId" [nzShowSearch]="true"
              style="width:100%;">
              <nz-option *ngFor="let i of employeeList" [nzLabel]="i.text" [nzValue]="i.value">
              </nz-option>
            </nz-select>
            <nz-form-explain *ngIf="(form.get('projectSalesId')?.dirty && form.get('projectSalesId')?.errors)
                  ">项目销售不能为空
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" nzRequired="true" class="labelPadding" [nzXs]="24">销售助理</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-select [nzPlaceHolder]="'请选择销售助理'" [nzDisabled]="project.status>1?true:false"
              formControlName="salesAssistantId" [(ngModel)]="project.salesAssistantId" [nzShowSearch]="true"
              style="width:100%;">
              <nz-option *ngFor="let i of employeeList" [nzLabel]="i.text" [nzValue]="i.value">
              </nz-option>
            </nz-select>
            <nz-form-explain *ngIf="(form.get('salesAssistantId')?.dirty && form.get('salesAssistantId')?.errors)
              ">销售助理不能为空
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">提前执行金额(元)</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-input-number formControlName="implementMoney" [nzDisabled]="project.status>1?true:false" nzPrecision="2"
              style="width:100%" placeholder="请输入提前执行金额" [(ngModel)]="project.implementMoney"></nz-input-number>
            <nz-form-explain *ngIf="(form.get('implementMoney')?.dirty && form.get('implementMoney')?.errors)
              ">提前执行金额不能为空,且不能超过18位
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">客户名称</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-select [nzPlaceHolder]="'请选择客户名称'" [nzDisabled]="project.status>1?true:false"
              formControlName="customerId" [(ngModel)]="project.customerId" [nzShowSearch]="true"
              (ngModelChange)="getDeptNameAndContacts()" style="width:100%;">
              <nz-option *ngFor="let i of customerList" [nzLabel]="i.text" [nzValue]="i.value">
              </nz-option>
            </nz-select>
            <nz-form-explain *ngIf="(form.get('customerId')?.dirty && form.get('customerId')?.errors)
            ">客户名称不能为空,且不能超过50个字符
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">客户联系人</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-select [nzPlaceHolder]="'请选择客户联系人'" [nzDisabled]="project.status>1?true:false"
              formControlName="customerContactId" [(ngModel)]="project.customerContactId" [nzShowSearch]="true"
              style="width:100%;">
              <nz-option *ngFor="let i of CustomerContacts" [nzLabel]="i.text" [nzValue]="i.value">
              </nz-option>
            </nz-select>
            <nz-form-explain *ngIf="(form.get('customerContactId')?.dirty && form.get('customerContactId')?.errors)
            ">客户联系人不能为空,且不能超过50个字符
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8" *ngIf="project.mode=='2'">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">收益比例</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-input-number formControlName="profitRatio" [nzDisabled]="project.status>1?true:false" style="width:94%"
              placeholder="请输入收益比例" [(ngModel)]="project.profitRatio">
            </nz-input-number>%
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8" *ngIf="project.mode=='3'">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">过单费用(元)</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-input-number formControlName="billCost" [nzDisabled]="project.status>1?true:false" nzMax="18"
              nzPrecision="2" style="width:100%" placeholder="请输入过单费用" [(ngModel)]="project.billCost">
            </nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" class="labelPadding" [nzXs]="24">开始日期</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-date-picker [nzStyle]='{width:"100%"}' [nzDisabled]="project.status>1?true:false" placeholder="请选择开始日期"
              formControlName="startDate" [(ngModel)]="project.startDate"></nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" class="labelPadding" [nzXs]="24">结束日期</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-date-picker [nzStyle]='{width:"100%"}' [nzDisabled]="project.status>1?true:false" placeholder="请选择开始日期"
              [nzFormat]="yyyy" formControlName="endDate" [(ngModel)]="project.endDate">
            </nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="24">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="2" style="width: 9.4% !important" class="labelPadding" [nzXs]="24">项目描述
          </nz-form-label>
          <nz-form-control [nzSm]="22" style="width: 90.6% !important" class="controlPadding" nzHasFeedback>
            <textarea nz-input rows="2" *ngIf="project.status==1" formControlName="desc" placeholder="请输入项目描述"
              [(ngModel)]="project.desc"></textarea>
            <textarea nz-input rows="2" *ngIf="project.status!=1" readonly formControlName="desc" placeholder="请输入项目描述"
              [(ngModel)]="project.desc"></textarea>
            <nz-form-explain *ngIf="(form.get('desc')?.dirty && form.get('desc')?.errors)
              ">备注不能超过250个字符
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row [nzGutter]="24" *ngIf="project.statusName=='立项'">
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">销售预算金额(元)</nz-form-label>
          <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
            <nz-input-number formControlName="budget" nzPrecision="2" nzMax="18" style="width:100%"
              placeholder="请输入预算金额金额" [(ngModel)]="project.budget"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-form-item nzFlex>
          <!-- <nz-form-label [nzSm]="7" class="labelPadding" nzRequired >销售预算金额(元)</nz-form-label> -->
          <nz-form-control [nzSm]="16" [nzXs]="24" nzHasFeedback>
            <button nz-button type="button" [nzType]="'primary'" *ngIf="project.status=='2'">预计成本</button>
          </nz-form-control>
        </nz-form-item>
      </div>

    </div>

    <!--<nz-card [nzBordered]="true" nzTitle="项目明细" class="mb-lg" [nzExtra]="project.status!=6?detailTemplate:''">
       <form nz-form [nzLayout]="'inline'" class="search__form">
        <div nz-row [nzGutter]="{ xs: 8, sm: 8, md: 8, lg: 24, xl: 48, xxl: 48 }">
          <div nz-col [nzSpan]="24" style="text-align: right" *ngIf="project.status!=0">
            <button nz-button (click)="createProjectDetail()" nzType="primary">
              <i class="anticon anticon-plus"></i>
              <span>新建</span>
            </button>
          </div>
        </div>
      </form> 
      <ng-template #detailTemplate>
        <button nz-button type="button" (click)="createProjectDetail()" nzType="primary">
          <i class="anticon anticon-plus"></i>
          <span>新建</span>
        </button>
      </ng-template>
      <nz-table #nzprojectDetailTable [nzData]="projectDetails" [nzFrontPagination]="false" [nzLoading]="loading"
        [nzShowPagination]="false">
        <thead nz-thead>
          <tr>
            <th nz-th>
              <span>商品/服务名称</span>
            </th>
            <th nz-th>
              <span>明细分类</span>
            </th>
            <th nz-th>
              <span>规格型号</span>
            </th>
            <th nz-th>
              <span>单位</span>
            </th>
            <th nz-th style="text-align: right">
              <span>数量</span>
            </th>
            <th style="text-align: right">
              <span>销售单价(元)</span>
            </th>
            <th style="text-align: right">
              <span>总金额(元)</span>
            </th>
            <th style="text-align: center" *ngIf="project.status!=6">
              <span>操作</span>
            </th>
          </tr>
        </thead>
        <tbody nz-tbody>
          <tr nz-tbody-tr *ngFor="let item of nzprojectDetailTable.data; let i = index">
            <td nz-td>{{item.name}}</td>
            <td nz-td>{{item.type}}</td>
            <td nz-td>{{item.specification}}</td>
            <td nz-td>{{item.unit}}</td>
            <td nz-td style="text-align: right">{{item.num}} </td>
            <td nz-td style="text-align: right">{{item.price}} </td>
            <td nz-td style="text-align: right">{{item.totalSum}} </td>
            <td nz-td style="text-align: center" *ngIf="project.status!=6">
              <a (click)="editProjectDetail(item,i)" *ngIf="item.name!='合计'">编辑</a>
              <span nz-table-divider></span>
              <nz-divider nzType="vertical" *ngIf="item.name!='合计'"></nz-divider>
              <a style="color:#ff4d4f;" *ngIf="item.name!='合计'" (click)="delete(item,i)">删除</a>
              <span nz-table-divider></span>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </nz-card>-->
    <div class="modal-footer">
      <button nz-button type="button" [disabled]="saving" (click)="goBack()">
        返回
      </button>
    </div>
  </form>
</nz-card>
