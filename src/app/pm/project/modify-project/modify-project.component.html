<!-- <page-header title="{{title}}">
</page-header> -->
<!-- <nz-card [nzBordered]="false"> -->
<form nz-form [formGroup]="form" #validateForm="ngForm" class="ant-advanced-search-form" (ngSubmit)="save()"
  *ngIf="project">
  <div nz-row [nzGutter]="24">
    <!-- <nz-steps [nzCurrent]="projectStatus.indexOf(project.statusName)" nzProgressDot>
        <nz-step *ngFor="let text of projectStatus" [nzTitle]="text" (click)="step($event)">
        </nz-step>
      </nz-steps> -->
    <page-header title="{{projectTitle}}" [action]="extraTemplate">
      <ng-template #extraTemplate>
        <button nz-button type="button" class="button-gray" *ngIf="project.status==2" (click)="loseOrder()">丢单</button>
        <button nz-button [nzType]="'primary'" type="submit" *ngIf="project.status<=2"
          [disabled]="!validateForm.valid||saving">保存</button>
        <button nz-button type="button" class="button-green" *ngIf="project.status==1" (click)="submit()"
          [disabled]="!validateForm.valid||saving">去立项</button>
        <button nz-button type="button" class="button-green" *ngIf="project.status==2" (click)="tenders()">完成立项</button>
      </ng-template>
    </page-header>
  </div>
  <div nz-row [nzGutter]="24">
    <div nz-col [nzSpan]="8" *ngIf="project.status=='1'">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">项目名称</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <input nz-input formControlName="name" *ngIf="project.status==1" placeholder="请输入项目名称"
            [(ngModel)]="project.name" />
          <input nz-input formControlName="name" *ngIf="project.status!=1" readonly placeholder="请输入项目名称"
            [(ngModel)]="project.name" />
          <nz-form-explain *ngIf="(form.get('name')?.dirty && form.get('name')?.errors)
              ">项目名称不能为空且不能超过100个字符
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8" *ngIf="project.status!='1'" hidden>
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">项目名称</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <input nz-input formControlName="name" *ngIf="project.status==1" placeholder="请输入项目名称"
            [(ngModel)]="project.name" />
          <input nz-input formControlName="name" *ngIf="project.status!=1" readonly placeholder="请输入项目名称"
            [(ngModel)]="project.name" />
          <nz-form-explain *ngIf="(form.get('name')?.dirty && form.get('name')?.errors)
                ">项目名称不能为空且不能超过100个字符
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">项目类型</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-select [nzPlaceHolder]="'请选择项目类型'" [nzDisabled]="project.id?true:false" formControlName="type"
            [(ngModel)]="project.type" [nzShowSearch]="true" (ngModelChange)="!project.id?generateProjectCode():''"
            style="width:100%;">
            <nz-option *ngFor="let i of typeList" [nzLabel]="i.text" [nzValue]="i.value">
            </nz-option>
          </nz-select>
          <nz-form-explain *ngIf="(form.get('type')?.dirty && form.get('type')?.errors)
            ">项目类型不能为空
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8">
      <nz-form-item nzFlex>
        <nz-form-label class="labelPadding" [nzSm]="7" nzRequired [nzXs]="24">项目模式
        </nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-select formControlName="mode" [nzDisabled]="project.status>1?true:false" [nzPlaceHolder]="'请选择项目模式'"
            [(ngModel)]="project.mode" [nzShowSearch]="true" style="width:100%;">
            <nz-option *ngFor="let i of projectMode" [nzLabel]="i.text" [nzValue]="i.value">
            </nz-option>
          </nz-select>
          <nz-form-explain *ngIf="(form.get('mode')?.dirty && form.get('mode')?.errors)
          ">项目模式不能为空
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" nzRequired="true" class="labelPadding" [nzXs]="24">项目销售</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-select [nzPlaceHolder]="'请选择项目销售'" [nzDisabled]="project.status>1?true:false"
            formControlName="projectSalesId" [(ngModel)]="project.projectSalesId" [nzShowSearch]="true"
            style="width:100%;">
            <nz-option *ngFor="let i of employeeList" [nzLabel]="i.text" [nzValue]="i.value">
            </nz-option>
          </nz-select>
          <nz-form-explain *ngIf="(form.get('projectSalesId')?.dirty && form.get('projectSalesId')?.errors)
                  ">项目销售不能为空
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" nzRequired="true" class="labelPadding" [nzXs]="24">销售助理</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-select [nzPlaceHolder]="'请选择销售助理'" [nzDisabled]="project.status>1?true:false"
            formControlName="salesAssistantId" [(ngModel)]="project.salesAssistantId" [nzShowSearch]="true"
            style="width:100%;">
            <nz-option *ngFor="let i of employeeList" [nzLabel]="i.text" [nzValue]="i.value">
            </nz-option>
          </nz-select>
          <nz-form-explain *ngIf="(form.get('salesAssistantId')?.dirty && form.get('salesAssistantId')?.errors)
              ">销售助理不能为空
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">客户名称</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-select [nzPlaceHolder]="'请选择客户名称'" [nzDisabled]="project.status>1?true:false" formControlName="customerId"
            [(ngModel)]="project.customerId" [nzShowSearch]="true" (ngModelChange)="getDeptNameAndContacts()"
            style="width:100%;">
            <nz-option *ngFor="let i of customerList" [nzLabel]="i.text" [nzValue]="i.value">
            </nz-option>
          </nz-select>
          <nz-form-explain *ngIf="(form.get('customerId')?.dirty && form.get('customerId')?.errors)
            ">客户名称不能为空,且不能超过50个字符
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">客户联系人</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-select [nzPlaceHolder]="'请选择客户联系人'" [nzDisabled]="project.status>1?true:false"
            formControlName="customerContactId" [(ngModel)]="project.customerContactId" [nzShowSearch]="true"
            style="width:100%;">
            <nz-option *ngFor="let i of CustomerContacts" [nzLabel]="i.text" [nzValue]="i.value">
            </nz-option>
          </nz-select>
          <nz-form-explain *ngIf="(form.get('customerContactId')?.dirty && form.get('customerContactId')?.errors)
            ">客户联系人不能为空,且不能超过50个字符
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8" *ngIf="project.mode=='2'">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">收益比例</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-input-number formControlName="profitRatio" [nzDisabled]="project.status>1?true:false" style="width:94%"
            placeholder="请输入收益比例" [(ngModel)]="project.profitRatio">
          </nz-input-number>%
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8" *ngIf="project.mode=='3'">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">过单费用(元)</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-input-number formControlName="billCost" [nzDisabled]="project.status>1?true:false" nzMax="99999999999999"
            nzPrecision="2" style="width:100%" placeholder="请输入过单费用" [(ngModel)]="project.billCost">
          </nz-input-number>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" class="labelPadding" [nzXs]="24">开始日期</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-date-picker [nzStyle]='{width:"100%"}' [nzDisabled]="project.status>1?true:false" placeholder="请选择开始日期"
            formControlName="startDate" [(ngModel)]="project.startDate"></nz-date-picker>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" class="labelPadding" [nzXs]="24">结束日期</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-date-picker [nzStyle]='{width:"100%"}' [nzDisabled]="project.status>1?true:false" placeholder="请选择开始日期"
            [nzFormat]="yyyy" formControlName="endDate" [(ngModel)]="project.endDate">
          </nz-date-picker>
        </nz-form-control>
      </nz-form-item>
    </div>
  </div>
  <div nz-row [nzGutter]="24">
    <div nz-col [nzSpan]="24">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="2" style="width: 9.4% !important" class="labelPadding" [nzXs]="24">项目描述
        </nz-form-label>
        <nz-form-control [nzSm]="22" style="width: 90.6% !important" class="controlPadding" nzHasFeedback>
          <textarea nz-input rows="2" *ngIf="project.status==1" formControlName="desc" placeholder="请输入项目描述"
            [(ngModel)]="project.desc"></textarea>
          <textarea nz-input rows="2" *ngIf="project.status!=1" readonly formControlName="desc" placeholder="请输入项目描述"
            [(ngModel)]="project.desc"></textarea>
          <nz-form-explain *ngIf="(form.get('desc')?.dirty && form.get('desc')?.errors)
              ">备注不能超过250个字符
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>
    </div>
  </div>
  <div nz-row [nzGutter]="24" *ngIf="project.status=='2'||prjectName=='立项'">
    <div nz-col [nzSpan]="8">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">销售预算金额(元)</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-input-number formControlName="budget" [nzDisabled]="project.status!='2'" nzPrecision="2"
            nzMax="99999999999999" style="width:100%" placeholder="请输入预算金额金额" [(ngModel)]="project.budget">
          </nz-input-number>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8" *ngIf="project.type=='软件开发'||project.type=='系统集成'">
      <nz-form-item nzFlex>
        <nz-form-label [nzSm]="7" class="labelPadding" nzRequired [nzXs]="24">提前执行金额(元)</nz-form-label>
        <nz-form-control [nzSm]="16" class="controlPadding" nzHasFeedback>
          <nz-input-number formControlName="implementMoney" [nzDisabled]="project.status!=2" nzPrecision="2"
            style="width:100%" placeholder="请输入提前执行金额" [(ngModel)]="project.implementMoney"></nz-input-number>
          <nz-form-explain *ngIf="(form.get('implementMoney')?.dirty && form.get('implementMoney')?.errors)
                ">提前执行金额不能为空,且不能超过18位
          </nz-form-explain>
        </nz-form-control>
      </nz-form-item>
    </div>
    <div nz-col [nzSpan]="8" *ngIf="projectDetails.value.length==0&&project.status=='2'">
      <nz-form-item nzFlex>
        <nz-form-control [nzSm]="16" [nzXs]="24" nzHasFeedback>
          <button nz-button type="button" [nzType]="'primary'" (click)="estimatedCost()"
            *ngIf="project.status=='2'">预计成本</button>
        </nz-form-control>
      </nz-form-item>
    </div>

  </div>

  <nz-card [nzBordered]="true" class="mb-lg" *ngIf="projectDetails.value.length>0&&prjectName=='立项'">
    <nz-table #nzTable formArrayName="projectDetails" [nzData]="projectDetails.value" [nzShowPagination]="false">
      <thead nz-thead>
        <tr>
          <th nz-th>成本名称</th>
          <th nz-th style="text-align: center">数量</th>
          <th nz-th style="text-align: center">单价</th>
          <th nz-th style="text-align: center">合计</th>
          <th nz-th style="text-align: center">操作</th>
        </tr>
      </thead>
      <tbody nz-tbody>
        <tr nz-tbody-tr *ngFor="let item of projectDetails.controls; let i = index" [formGroupName]="i">
          <td nz-td>
            <span *ngIf="editIndex!==i">{{projectDetails.value[i].name}}</span>
            <span *ngIf="editIndex===i" nz-form-control>
              <input nz-input formControlName="name" placeholder="请输入名称">
            </span>
          </td>
          <td nz-td style="text-align: center">
            <span *ngIf="editIndex!==i">{{projectDetails.value[i].num}}</span>
            <span *ngIf="editIndex===i" nz-form-control>
              <nz-input-number nz-input formControlName="num" nzMax="99999999999999" nzPrecision="2"
                placeholder="请输入数量">
              </nz-input-number>
            </span>
          </td>
          <td nz-td style="text-align: center">
            <span *ngIf="editIndex!==i">{{projectDetails.value[i].price}}</span>
            <span *ngIf="editIndex===i" nz-form-control>
              <nz-input-number nz-input formControlName="price" nzMax="99999999999999" nzPrecision="2"
                placeholder="请输入单价">
              </nz-input-number>
            </span>
          </td>
          <td nz-td style="text-align: center">
            <span *ngIf="editIndex!==i">{{(projectDetails.value[i].price*100)*projectDetails.value[i].num/100}}</span>
          </td>
          <td nz-td style="text-align: center">
            <span *ngIf="editIndex!==i && projectDetails.value[i].name!='合计'">
              <a (click)="edit(i)">编辑</a>
              <nz-divider nzType="vertical"></nz-divider>
              <nz-popconfirm (nzOnConfirm)="del(i,projectDetails.value[i].id)" [nzTitle]="'是否要删除此行数据？'">
                <a nz-popconfirm>删除</a>
              </nz-popconfirm>
            </span>
            <span *ngIf="editIndex===i && projectDetails.value[i].name!='合计'">
              <a (click)="saveProjectDetail(i)">保存</a>
              <nz-divider nzType="vertical"></nz-divider>
              <nz-popconfirm (nzOnConfirm)="cancel(i,projectDetails.value[i].id)" [nzTitle]="'是否要取消操作？'">
                <a nz-popconfirm>删除</a>
              </nz-popconfirm>
            </span>
          </td>
        </tr>
      </tbody>
    </nz-table>
    <button *ngIf="editIndex===-1" nz-button [nzType]="'dashed'" (click)="add()" nzBlock class="mt-md">
      <i nz-icon type="plus"></i>
      <span>新增预计成本</span>
    </button>
    <div class="modal-footer">
      <label style="margin-right: 10%;font-weight: bold">总计：{{totalAmount}}</label>
    </div>
  </nz-card>
</form>
<!-- </nz-card> -->
